<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>動画配信サイトPiPテスト - YouTube風</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #0f0f0f;
        color: white;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }
      .video-container {
        position: relative;
        width: 100%;
        max-width: 854px;
        margin: 0 auto 20px;
        background: #000;
        border-radius: 12px;
        overflow: hidden;
      }
      .video-player {
        width: 100%;
        height: 480px;
        background: linear-gradient(45deg, #1a1a1a, #333);
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .test-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .video-info {
        padding: 16px;
        background: #0f0f0f;
      }
      .video-title {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 12px;
        line-height: 1.3;
      }
      .video-meta {
        display: flex;
        align-items: center;
        gap: 12px;
        color: #aaaaaa;
        font-size: 14px;
      }
      .test-buttons {
        display: flex;
        gap: 12px;
        margin: 20px 0;
        flex-wrap: wrap;
      }
      .test-btn {
        padding: 12px 24px;
        background: #ff0000;
        color: white;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.2s ease;
        font-size: 14px;
      }
      .test-btn:hover {
        background: #cc0000;
      }
      .test-btn.secondary {
        background: #065fd4;
      }
      .test-btn.secondary:hover {
        background: #0a4ba0;
      }
      .test-btn.success {
        background: #00c851;
      }
      .test-btn.success:hover {
        background: #00a041;
      }
      .sidebar {
        margin-top: 20px;
      }
      .related-video {
        display: flex;
        gap: 12px;
        margin-bottom: 12px;
        padding: 8px;
        border-radius: 8px;
        background: #1f1f1f;
      }
      .related-video img {
        width: 168px;
        height: 94px;
        border-radius: 8px;
        background: #333;
        object-fit: cover;
      }
      .related-info {
        flex: 1;
      }
      .related-title {
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 4px;
        line-height: 1.3;
      }
      .related-meta {
        font-size: 12px;
        color: #aaaaaa;
      }
      .status {
        margin: 20px 0;
        padding: 12px;
        border-radius: 8px;
        background: #1f1f1f;
      }
      .iframe-container {
        margin: 20px 0;
        border-radius: 12px;
        overflow: hidden;
        background: #000;
      }
      .iframe-container iframe {
        width: 100%;
        height: 315px;
        border: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>🎬 動画配信サイト強制PiPテスト</h1>

      <div class="status">
        <h3>📊 現在のサイト状況</h3>
        <p id="siteStatus">サイト判定中...</p>
        <p id="pipStatus">PiP機能状況: 初期化中...</p>
      </div>

      <!-- メインの動画プレイヤー（disablepictureinpictureあり） -->
      <div class="video-container">
        <div class="video-player">
          <video
            id="mainVideo"
            class="test-video"
            controls
            disablepictureinpicture
            poster="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='854' height='480'%3E%3Crect width='100%25' height='100%25' fill='%23000'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' fill='white' font-size='24'%3E🎬 メイン動画 (PiP無効化済み)%3C/text%3E%3C/svg%3E"
          >
            <source
              src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4"
              type="video/mp4"
            />
            <source
              src="https://www.learningcontainer.com/wp-content/uploads/2020/05/sample-mp4-file.mp4"
              type="video/mp4"
            />
            <p>動画を再生できません。</p>
          </video>
        </div>
        <div class="video-info">
          <h2 class="video-title">
            🔴 ライブ配信テスト - disablepictureinpicture属性付き動画
          </h2>
          <div class="video-meta">
            <span>1,234,567回視聴</span>
            <span>•</span>
            <span>2024年6月9日にライブ配信</span>
          </div>
        </div>
      </div>

      <!-- テスト用ボタン群 -->
      <div class="test-buttons">
        <button class="test-btn" onclick="testNormalPiP()">
          📺 通常PiP試行
        </button>
        <button class="test-btn secondary" onclick="testForcePiP()">
          🚀 強制PiP実行
        </button>
        <button class="test-btn success" onclick="testStreamingPiP()">
          🎯 配信サイト向けPiP
        </button>
        <button class="test-btn" onclick="testFrameCapture()">
          📸 フレームキャプチャ
        </button>
        <button class="test-btn secondary" onclick="testAreaCapture()">
          🎪 動画領域キャプチャ
        </button>
        <button class="test-btn" onclick="testScreenCapture()">
          🖥️ 画面キャプチャ
        </button>
        <button
          class="test-btn"
          onclick="exitAllPiP()"
          style="background: #ff6b6b"
        >
          ❌ 全PiP終了
        </button>
      </div>

      <!-- 埋め込み動画（iframe） -->
      <div class="iframe-container">
        <h3>📺 埋め込み動画テスト</h3>
        <iframe
          id="embeddedVideo"
          src="data:text/html,%3Chtml%3E%3Cbody style='margin:0;background:%23000;display:flex;align-items:center;justify-content:center;color:white;font-family:Arial;'%3E%3Cvideo controls disablepictureinpicture style='width:100%25;height:100%25;'%3E%3Csource src='https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4' type='video/mp4'%3E%3C/video%3E%3C/body%3E%3C/html%3E"
          allowfullscreen
        >
        </iframe>
      </div>

      <!-- 関連動画 -->
      <div class="sidebar">
        <h3>📋 関連動画</h3>
        <div class="related-video">
          <img
            src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='168' height='94'%3E%3Crect width='100%25' height='100%25' fill='%23333'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' fill='white' font-size='12'%3E関連動画1%3C/text%3E%3C/svg%3E"
            alt="関連動画1"
          />
          <div class="related-info">
            <div class="related-title">YouTube風サイトでのPiPテスト方法</div>
            <div class="related-meta">
              テストチャンネル • 123万回視聴 • 1日前
            </div>
          </div>
        </div>
        <div class="related-video">
          <img
            src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='168' height='94'%3E%3Crect width='100%25' height='100%25' fill='%23333'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' fill='white' font-size='12'%3E関連動画2%3C/text%3E%3C/svg%3E"
            alt="関連動画2"
          />
          <div class="related-info">
            <div class="related-title">TVerでPiPを強制的に有効にする方法</div>
            <div class="related-meta">
              開発者チャンネル • 456万回視聴 • 3日前
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // サイト判定とPiP機能の初期化状況を表示
      function updateStatus() {
        const domain = window.location.hostname || "localhost";
        const siteStatus = document.getElementById("siteStatus");
        const pipStatus = document.getElementById("pipStatus");

        siteStatus.textContent = `現在のドメイン: ${domain} (テストサイト)`;

        if (typeof window.pipHandler !== "undefined") {
          pipStatus.textContent =
            "PiP機能状況: ✅ PictureInPictureHandler初期化済み";
          pipStatus.style.color = "#4CAF50";
        } else {
          pipStatus.textContent =
            "PiP機能状況: ❌ PictureInPictureHandler未初期化";
          pipStatus.style.color = "#f44336";
        }
      }

      // 通常のPiP試行
      function testNormalPiP() {
        console.log("=== 通常PiP試行テスト ===");
        const video = document.getElementById("mainVideo");

        if (video && video.requestPictureInPicture) {
          video
            .requestPictureInPicture()
            .then(() => {
              console.log("✅ 通常PiP成功");
              alert("✅ 通常PiPが成功しました！");
            })
            .catch((error) => {
              console.error("❌ 通常PiP失敗:", error);
              alert(`❌ 通常PiP失敗: ${error.message}`);
            });
        } else {
          alert("❌ PiP APIが利用できません");
        }
      }

      // 強制PiP実行
      function testForcePiP() {
        console.log("=== 強制PiP実行テスト ===");

        if (typeof window.pipHandler !== "undefined") {
          try {
            const result = window.pipHandler.executePictureInPicture();
            console.log("強制PiP実行結果:", result);
          } catch (error) {
            console.error("強制PiP実行エラー:", error);
            alert(`❌ 強制PiP実行エラー: ${error.message}`);
          }
        } else {
          alert("❌ PictureInPictureHandlerが初期化されていません");
        }
      }

      // 配信サイト向けPiP
      function testStreamingPiP() {
        console.log("=== 配信サイト向けPiP実行テスト ===");

        if (typeof window.forceVideoStreamingPiP !== "undefined") {
          try {
            const result = window.forceVideoStreamingPiP();
            console.log("配信サイト向けPiP実行結果:", result);
            if (result) {
              alert("✅ 配信サイト向けPiPが成功しました！");
            } else {
              alert("⚠️ 配信サイト向けPiPが失敗しました");
            }
          } catch (error) {
            console.error("配信サイト向けPiPエラー:", error);
            alert(`❌ 配信サイト向けPiPエラー: ${error.message}`);
          }
        } else {
          alert("❌ forceVideoStreamingPiP関数が利用できません");
        }
      }

      // フレームキャプチャ
      function testFrameCapture() {
        console.log("=== フレームキャプチャテスト ===");

        if (typeof window.tryFrameCapturePiP !== "undefined") {
          try {
            const result = window.tryFrameCapturePiP();
            console.log("フレームキャプチャ実行結果:", result);
            if (result) {
              alert("✅ フレームキャプチャPiPが成功しました！");
            } else {
              alert("⚠️ フレームキャプチャPiPが失敗しました");
            }
          } catch (error) {
            console.error("フレームキャプチャエラー:", error);
            alert(`❌ フレームキャプチャエラー: ${error.message}`);
          }
        } else {
          alert("❌ tryFrameCapturePiP関数が利用できません");
        }
      }

      // 動画領域キャプチャ
      function testAreaCapture() {
        console.log("=== 動画領域キャプチャテスト ===");

        if (typeof window.tryVideoAreaCapture !== "undefined") {
          try {
            const result = window.tryVideoAreaCapture();
            console.log("動画領域キャプチャ実行結果:", result);
            if (result) {
              alert("✅ 動画領域キャプチャPiPが成功しました！");
            } else {
              alert("⚠️ 動画領域キャプチャPiPが失敗しました");
            }
          } catch (error) {
            console.error("動画領域キャプチャエラー:", error);
            alert(`❌ 動画領域キャプチャエラー: ${error.message}`);
          }
        } else {
          alert("❌ tryVideoAreaCapture関数が利用できません");
        }
      }

      // 画面キャプチャ
      function testScreenCapture() {
        console.log("=== 画面キャプチャテスト ===");

        if (typeof window.createScreenCapturePiP !== "undefined") {
          try {
            const result = window.createScreenCapturePiP();
            console.log("画面キャプチャ実行結果:", result);
            alert("✅ 画面キャプチャPiPウィンドウが作成されました！");
          } catch (error) {
            console.error("画面キャプチャエラー:", error);
            alert(`❌ 画面キャプチャエラー: ${error.message}`);
          }
        } else {
          alert("❌ createScreenCapturePiP関数が利用できません");
        }
      }

      // 全PiP終了
      function exitAllPiP() {
        console.log("=== 全PiP終了テスト ===");

        if (typeof window.exitAllPiP !== "undefined") {
          try {
            window.exitAllPiP();
            alert("✅ 全てのPiPウィンドウを終了しました");
          } catch (error) {
            console.error("全PiP終了エラー:", error);
            alert(`❌ 全PiP終了エラー: ${error.message}`);
          }
        } else {
          alert("❌ exitAllPiP関数が利用できません");
        }
      }

      // ページ読み込み時に状況を更新
      document.addEventListener("DOMContentLoaded", () => {
        updateStatus();

        // 1秒後に再度チェック（PiPハンドラーの初期化を待つ）
        setTimeout(updateStatus, 1000);

        console.log("🎬 動画配信サイトPiPテストページが読み込まれました");
        console.log("利用可能なテスト機能:");
        console.log("- 通常PiP試行");
        console.log("- 強制PiP実行");
        console.log("- 配信サイト向けPiP");
        console.log("- フレームキャプチャ");
        console.log("- 動画領域キャプチャ");
        console.log("- 画面キャプチャ");
        console.log("- 全PiP終了");
      });

      // 動画の準備ができたらログ出力
      document
        .getElementById("mainVideo")
        .addEventListener("loadedmetadata", () => {
          console.log("📺 メイン動画のメタデータが読み込まれました");
          console.log(
            "disablepictureinpicture属性:",
            document
              .getElementById("mainVideo")
              .hasAttribute("disablepictureinpicture")
          );
        });
    </script>
  </body>
</html>
