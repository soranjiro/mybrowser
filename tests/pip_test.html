<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Picture-in-Pictureæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ - MyBrowser</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        min-height: 100vh;
      }
      .container {
        background: rgba(255, 255, 255, 0.1);
        -webkit-backdrop-filter: blur(10px);
        backdrop-filter: blur(10px);
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        max-width: 1000px;
        margin: 0 auto;
      }
      h1 {
        text-align: center;
        margin-bottom: 30px;
      }
      .test-section {
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        margin: 20px 0;
        border-radius: 10px;
      }
      .video-container {
        text-align: center;
        margin: 20px 0;
      }
      video {
        width: 100%;
        max-width: 500px;
        border-radius: 8px;
        margin: 10px 0;
      }
      button {
        padding: 12px 20px;
        margin: 8px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.3s;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #6c757d;
        opacity: 0.6;
        cursor: not-allowed;
      }
      .status-area {
        background: rgba(0, 0, 0, 0.3);
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
      }
      #log {
        background: #000;
        color: #0f0;
        padding: 15px;
        border-radius: 5px;
        height: 200px;
        overflow-y: auto;
        font-family: monospace;
        margin-top: 10px;
      }
      .api-status {
        background: rgba(255, 255, 255, 0.2);
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
      }
      .status-supported {
        color: #28a745;
        font-weight: bold;
      }
      .status-not-supported {
        color: #dc3545;
        font-weight: bold;
      }
      .video-info {
        font-size: 14px;
        color: rgba(255, 255, 255, 0.8);
        margin: 5px 0;
      }
      .warning {
        background: rgba(255, 193, 7, 0.2);
        border: 1px solid #ffc107;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ¥ Picture-in-Pictureæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</h1>

      <!-- API ã‚µãƒãƒ¼ãƒˆçŠ¶æ³ -->
      <div class="api-status">
        <h2>ğŸ“‹ API ã‚µãƒãƒ¼ãƒˆçŠ¶æ³</h2>
        <div id="api-support-info">
          ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¾Œã«è‡ªå‹•ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¾ã™...
        </div>
      </div>

      <!-- é€šå¸¸ã®ãƒ“ãƒ‡ã‚ªï¼ˆPiPæœ‰åŠ¹ï¼‰ -->
      <div class="test-section">
        <h2>1. é€šå¸¸ã®ãƒ“ãƒ‡ã‚ªï¼ˆPiPæœ‰åŠ¹ï¼‰</h2>
        <div class="video-container">
          <video id="normalVideo" controls muted>
            <source
              src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4"
              type="video/mp4"
            />
            <source
              src="https://www.w3schools.com/html/mov_bbb.mp4"
              type="video/mp4"
            />
            ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ“ãƒ‡ã‚ªã‚¿ã‚°ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚
          </video>
          <div class="video-info">
            ãƒ“ãƒ‡ã‚ªã‚½ãƒ¼ã‚¹: Big Buck Bunny (ã‚µãƒ³ãƒ—ãƒ«å‹•ç”»)
          </div>
        </div>
        <div>
          <button onclick="playVideo('normalVideo')">â–¶ï¸ å†ç”Ÿ</button>
          <button onclick="pauseVideo('normalVideo')">â¸ï¸ ä¸€æ™‚åœæ­¢</button>
          <button onclick="requestPiP('normalVideo')">ğŸš€ PiPé–‹å§‹</button>
          <button onclick="checkVideoState('normalVideo')">ğŸ“Š çŠ¶æ…‹ç¢ºèª</button>
        </div>
      </div>

      <!-- disablePictureInPictureãŒè¨­å®šã•ã‚ŒãŸãƒ“ãƒ‡ã‚ª -->
      <div class="test-section">
        <h2>2. PiPç„¡åŠ¹ãƒ“ãƒ‡ã‚ª (disablePictureInPicture="true")</h2>
        <div class="video-container">
          <video
            id="disabledVideo"
            controls
            muted
            disablePictureInPicture="true"
          >
            <source
              src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4"
              type="video/mp4"
            />
            <source
              src="https://www.w3schools.com/html/mov_bbb.mp4"
              type="video/mp4"
            />
            ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ“ãƒ‡ã‚ªã‚¿ã‚°ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚
          </video>
          <div class="video-info">ãƒ“ãƒ‡ã‚ªã‚½ãƒ¼ã‚¹: Elephants Dream (PiPç„¡åŠ¹)</div>
        </div>
        <div class="warning">
          âš ï¸
          ã“ã®ãƒ“ãƒ‡ã‚ªã¯disablePictureInPictureå±æ€§ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€PiPã¯å‹•ä½œã—ã¾ã›ã‚“ã€‚
        </div>
        <div>
          <button onclick="playVideo('disabledVideo')">â–¶ï¸ å†ç”Ÿ</button>
          <button onclick="pauseVideo('disabledVideo')">â¸ï¸ ä¸€æ™‚åœæ­¢</button>
          <button onclick="requestPiP('disabledVideo')">
            ğŸš€ PiPé–‹å§‹ï¼ˆå¤±æ•—ã™ã‚‹ã¯ãšï¼‰
          </button>
          <button onclick="toggleDisablePiP('disabledVideo')">
            ğŸ”„ PiPåˆ¶é™åˆ‡ã‚Šæ›¿ãˆ
          </button>
        </div>
      </div>

      <!-- ãƒ­ãƒ¼ã‚«ãƒ«ãƒ“ãƒ‡ã‚ªãƒ•ã‚¡ã‚¤ãƒ«ç”¨ -->
      <div class="test-section">
        <h2>3. ãƒ­ãƒ¼ã‚«ãƒ«ãƒ“ãƒ‡ã‚ªãƒ•ã‚¡ã‚¤ãƒ«</h2>
        <div class="video-container">
          <video id="localVideo" controls muted>
            <source src="data:video/mp4;base64," type="video/mp4" />
            ãƒ­ãƒ¼ã‚«ãƒ«ãƒ“ãƒ‡ã‚ªãƒ•ã‚¡ã‚¤ãƒ«ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
          </video>
          <div class="video-info">
            ãƒ­ãƒ¼ã‚«ãƒ«ãƒ“ãƒ‡ã‚ªãƒ•ã‚¡ã‚¤ãƒ«ç”¨ï¼ˆè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯å‹•ä½œã—ã¾ã›ã‚“ï¼‰
          </div>
        </div>
        <label for="videoFileInput">ãƒ­ãƒ¼ã‚«ãƒ«ãƒ“ãƒ‡ã‚ªãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ:</label>
        <input
          type="file"
          id="videoFileInput"
          accept="video/*"
          onchange="loadLocalVideo()"
          title="ãƒ­ãƒ¼ã‚«ãƒ«ãƒ“ãƒ‡ã‚ªãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ"
        />
        <div>
          <button onclick="playVideo('localVideo')">â–¶ï¸ å†ç”Ÿ</button>
          <button onclick="requestPiP('localVideo')">ğŸš€ PiPé–‹å§‹</button>
        </div>
      </div>

      <!-- PiPå…¨ä½“åˆ¶å¾¡ -->
      <div class="test-section">
        <h2>4. PiPå…¨ä½“åˆ¶å¾¡</h2>
        <div>
          <button onclick="exitAllPiP()">ğŸ”š å…¨ã¦ã®PiPçµ‚äº†</button>
          <button onclick="testAllPiPSupport()">
            ğŸ” å…¨ãƒ“ãƒ‡ã‚ªã®PiPã‚µãƒãƒ¼ãƒˆç¢ºèª
          </button>
          <button onclick="removeAllPiPAttributes()">
            ğŸ—‘ï¸ å…¨ãƒ“ãƒ‡ã‚ªã®PiPåˆ¶é™è§£é™¤
          </button>
        </div>
      </div>

      <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»ãƒ­ã‚° -->
      <div class="status-area">
        <h2>ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»ãƒ­ã‚°</h2>
        <p>ç¾åœ¨ã®PiPãƒ“ãƒ‡ã‚ª: <span id="current-pip">ãªã—</span></p>
        <p>æœ€å¾Œã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: <span id="last-action">ãªã—</span></p>
        <button onclick="clearLog()">ğŸ—‘ï¸ ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
        <div id="log"></div>
      </div>
    </div>

    <script>
      let currentPiPVideo = null;

      function log(message, type) {
        const logDiv = document.getElementById("log");
        const timestamp = new Date().toLocaleTimeString();

        let prefix = "ğŸ“„";
        if (type === "success") prefix = "âœ…";
        else if (type === "error") prefix = "âŒ";
        else if (type === "warning") prefix = "âš ï¸";

        logDiv.innerHTML +=
          "[" + timestamp + "] " + prefix + " " + message + "\n";
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(prefix + " " + message);

        document.getElementById("last-action").textContent =
          message + " (" + timestamp + ")";
      }

      function clearLog() {
        document.getElementById("log").innerHTML = "";
        log("ãƒ­ã‚°ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸ");
      }

      function updatePiPStatus(videoId) {
        document.getElementById("current-pip").textContent = videoId || "ãªã—";
      }

      async function playVideo(videoId) {
        const video = document.getElementById(videoId);
        if (!video) {
          log("âŒ ãƒ“ãƒ‡ã‚ªè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: " + videoId, "error");
          return;
        }

        try {
          await video.play();
          log("â–¶ï¸ ãƒ“ãƒ‡ã‚ªå†ç”Ÿé–‹å§‹: " + videoId, "success");
        } catch (error) {
          log(
            "âŒ ãƒ“ãƒ‡ã‚ªå†ç”Ÿã‚¨ãƒ©ãƒ¼: " + videoId + " - " + error.message,
            "error"
          );
        }
      }

      function pauseVideo(videoId) {
        const video = document.getElementById(videoId);
        if (!video) {
          log("âŒ ãƒ“ãƒ‡ã‚ªè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: " + videoId, "error");
          return;
        }

        video.pause();
        log("â¸ï¸ ãƒ“ãƒ‡ã‚ªä¸€æ™‚åœæ­¢: " + videoId, "info");
      }

      async function requestPiP(videoId) {
        log("ğŸš€ PiPé–‹å§‹è©¦è¡Œ: " + videoId, "info");

        const video = document.getElementById(videoId);
        if (!video) {
          log("âŒ ãƒ“ãƒ‡ã‚ªè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: " + videoId, "error");
          return;
        }

        if (video.paused) {
          try {
            await video.play();
            log("â–¶ï¸ PiPç”¨ã«ãƒ“ãƒ‡ã‚ªã‚’å†ç”Ÿé–‹å§‹: " + videoId, "info");
          } catch (error) {
            log("âŒ ãƒ“ãƒ‡ã‚ªå†ç”Ÿå¤±æ•—: " + error.message, "error");
            return;
          }
        }

        try {
          const pipWindow = await video.requestPictureInPicture();
          currentPiPVideo = videoId;
          updatePiPStatus(videoId);
          log("âœ… PiPé–‹å§‹æˆåŠŸ: " + videoId, "success");
          log(
            "ğŸ“ PiPã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚º: " +
              pipWindow.width +
              " x " +
              pipWindow.height,
            "info"
          );

          pipWindow.addEventListener("resize", function () {
            log(
              "ğŸ“ PiPã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚º: " +
                pipWindow.width +
                " x " +
                pipWindow.height,
              "info"
            );
          });
        } catch (error) {
          log(
            "âŒ PiPé–‹å§‹ã‚¨ãƒ©ãƒ¼: " +
              videoId +
              " - " +
              error.name +
              ": " +
              error.message,
            "error"
          );
        }
      }

      async function exitAllPiP() {
        log("ğŸ”š å…¨PiPçµ‚äº†è©¦è¡Œ", "info");

        try {
          if (document.pictureInPictureElement) {
            await document.exitPictureInPicture();
            log("âœ… PiPçµ‚äº†æˆåŠŸ", "success");
          } else {
            log("ğŸ“Œ ç¾åœ¨PiPãƒ¢ãƒ¼ãƒ‰ã®ãƒ“ãƒ‡ã‚ªã¯ã‚ã‚Šã¾ã›ã‚“", "info");
          }
        } catch (error) {
          log("âŒ PiPçµ‚äº†ã‚¨ãƒ©ãƒ¼: " + error.message, "error");
        }
      }

      function checkVideoState(videoId) {
        log("ğŸ“Š ãƒ“ãƒ‡ã‚ªçŠ¶æ…‹ç¢ºèª: " + videoId, "info");

        const video = document.getElementById(videoId);
        if (!video) {
          log("âŒ ãƒ“ãƒ‡ã‚ªè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: " + videoId, "error");
          return;
        }

        log("ğŸ“Œ paused: " + video.paused, "info");
        log("ğŸ“Œ currentTime: " + video.currentTime.toFixed(2) + "s", "info");
        log(
          "ğŸ“Œ duration: " +
            (video.duration ? video.duration.toFixed(2) : "unknown") +
            "s",
          "info"
        );
        log("ğŸ“Œ readyState: " + video.readyState, "info");
        log("ğŸ“Œ networkState: " + video.networkState, "info");
        log("ğŸ“Œ videoWidth: " + video.videoWidth, "info");
        log("ğŸ“Œ videoHeight: " + video.videoHeight, "info");
        log(
          "ğŸ“Œ disablePictureInPicture: " + video.disablePictureInPicture,
          "info"
        );
      }

      function toggleDisablePiP(videoId) {
        const video = document.getElementById(videoId);
        if (!video) {
          log("âŒ ãƒ“ãƒ‡ã‚ªè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: " + videoId, "error");
          return;
        }

        video.disablePictureInPicture = !video.disablePictureInPicture;
        log(
          "ğŸ”„ " +
            videoId +
            " PiPåˆ¶é™: " +
            (video.disablePictureInPicture ? "æœ‰åŠ¹" : "ç„¡åŠ¹"),
          "info"
        );
      }

      function removeAllPiPAttributes() {
        const videos = document.querySelectorAll("video");
        videos.forEach(function (video, index) {
          if (video.hasAttribute("disablePictureInPicture")) {
            video.removeAttribute("disablePictureInPicture");
            log("ğŸ—‘ï¸ ãƒ“ãƒ‡ã‚ª" + (index + 1) + "ã®PiPåˆ¶é™ã‚’è§£é™¤", "info");
          }
        });
      }

      function testAllPiPSupport() {
        log("=== å…¨ãƒ“ãƒ‡ã‚ªã®PiPã‚µãƒãƒ¼ãƒˆç¢ºèª ===", "info");

        const videos = document.querySelectorAll("video");
        videos.forEach(function (video, index) {
          const videoId = video.id || "video-" + index;
          log("ğŸ“¹ ãƒ“ãƒ‡ã‚ª: " + videoId, "info");

          if ("requestPictureInPicture" in video) {
            log("  âœ… requestPictureInPicture: ã‚µãƒãƒ¼ãƒˆæ¸ˆã¿", "success");
          } else {
            log("  âŒ requestPictureInPicture: ã‚µãƒãƒ¼ãƒˆãªã—", "error");
          }

          log(
            "  ğŸ“Œ disablePictureInPicture: " + video.disablePictureInPicture,
            "info"
          );
        });
      }

      function loadLocalVideo() {
        const fileInput = document.getElementById("videoFileInput");
        const video = document.getElementById("localVideo");

        if (fileInput.files && fileInput.files[0]) {
          const file = fileInput.files[0];
          const url = URL.createObjectURL(file);
          video.src = url;
          log("ğŸ“ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ“ãƒ‡ã‚ªãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿: " + file.name, "success");
        }
      }

      function checkPiPSupport() {
        log("=== PiPã‚µãƒãƒ¼ãƒˆç¢ºèªé–‹å§‹ ===", "info");

        const apiInfo = document.getElementById("api-support-info");
        let supportInfo = "";

        if ("pictureInPictureEnabled" in document) {
          const enabled = document.pictureInPictureEnabled;
          supportInfo +=
            '<div class="' +
            (enabled ? "status-supported" : "status-not-supported") +
            '">document.pictureInPictureEnabled: ' +
            enabled +
            "</div>";
          log(
            "ğŸ“Œ document.pictureInPictureEnabled: " + enabled,
            enabled ? "success" : "error"
          );
        } else {
          supportInfo +=
            '<div class="status-not-supported">document.pictureInPictureEnabled: åˆ©ç”¨ä¸å¯</div>';
          log("âŒ document.pictureInPictureEnabled ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“", "error");
        }

        if ("pictureInPictureElement" in document) {
          const hasPiP = document.pictureInPictureElement !== null;
          supportInfo +=
            "<div>ç¾åœ¨ã®PiPè¦ç´ : " + (hasPiP ? "ã‚ã‚Š" : "ãªã—") + "</div>";
          log("ğŸ“Œ ç¾åœ¨ã®PiPè¦ç´ : " + (hasPiP ? "ã‚ã‚Š" : "ãªã—"), "info");
        }

        apiInfo.innerHTML = supportInfo;
        log("=== PiPã‚µãƒãƒ¼ãƒˆç¢ºèªå®Œäº† ===", "info");
      }

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
      document.addEventListener("enterpictureinpicture", function (event) {
        const videoId = event.target.id || "unknown";
        currentPiPVideo = videoId;
        updatePiPStatus(videoId);
        log("ğŸ‰ PiPãƒ¢ãƒ¼ãƒ‰é–‹å§‹: " + videoId, "success");
      });

      document.addEventListener("leavepictureinpicture", function (event) {
        const videoId = event.target.id || "unknown";
        currentPiPVideo = null;
        updatePiPStatus(null);
        log("ğŸ‘‹ PiPãƒ¢ãƒ¼ãƒ‰çµ‚äº†: " + videoId, "info");
      });

      // ãƒ“ãƒ‡ã‚ªã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      document.querySelectorAll("video").forEach(function (video) {
        video.addEventListener("loadedmetadata", function () {
          log("ğŸ¬ ãƒ“ãƒ‡ã‚ªãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†: " + video.id, "success");
        });

        video.addEventListener("canplay", function () {
          log("â–¶ï¸ ãƒ“ãƒ‡ã‚ªå†ç”Ÿæº–å‚™å®Œäº†: " + video.id, "success");
        });

        video.addEventListener("error", function (e) {
          log(
            "âŒ ãƒ“ãƒ‡ã‚ªã‚¨ãƒ©ãƒ¼: " +
              video.id +
              " - " +
              (e.message || "unknown error"),
            "error"
          );
        });
      });

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
      window.addEventListener("load", function () {
        log("ğŸš€ PiPãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ", "success");
        setTimeout(function () {
          checkPiPSupport();
        }, 1000);
      });
    </script>
  </body>
</html>
