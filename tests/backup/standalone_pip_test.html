<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Standalone PiP Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      .test-container {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
        backdrop-filter: blur(10px);
      }
      .test-image {
        max-width: 300px;
        border-radius: 10px;
        cursor: pointer;
        transition: transform 0.3s;
        margin: 10px;
      }
      .test-image:hover {
        transform: scale(1.05);
      }
      .button {
        background: #4caf50;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
        font-size: 16px;
      }
      .button:hover {
        background: #45a049;
      }
      .instructions {
        background: rgba(255, 255, 0, 0.2);
        padding: 15px;
        border-radius: 5px;
        margin: 20px 0;
      }
    </style>
  </head>
  <body>
    <h1>🖼️ Standalone Picture-in-Picture Test</h1>

    <div class="instructions">
      <h3>📋 テスト手順</h3>
      <ol>
        <li><strong>Ctrl+Alt+S</strong> でスタンドアロンPiPを起動</li>
        <li>下の画像をクリックしてPiPで表示</li>
        <li>Mission Control (F3) でSpaceを作成</li>
        <li>Space間を移動してPiPが全てのSpaceで見えることを確認</li>
      </ol>
    </div>

    <div class="test-container">
      <h2>🖼️ テスト画像</h2>
      <div>
        <!-- Base64エンコードされたテスト画像 -->
        <img
          class="test-image"
          src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iZ3JhZGllbnQiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdG9wLWNvbG9yPSIjZmY2YjZiIi8+CiAgICAgIDxzdG9wIG9mZnNldD0iMTAwJSIgc3RvcC1jb2xvcj0iIzRlY2RjNCIvPgogICAgPC9saW5lYXJHcmFkaWVudD4KICA8L2RlZnM+CiAgPHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0idXJsKCNncmFkaWVudCkiLz4KICA8Y2lyY2xlIGN4PSIxNTAiIGN5PSIxMDAiIHI9IjQwIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuOCkiLz4KICA8dGV4dCB4PSIxNTAiIHk9IjEwNSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjE2IiBmaWxsPSIjMzMzIj5QaVA8L3RleHQ+CiAgPHRleHQgeD0iMTUwIiB5PSI0MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjIwIiBmaWxsPSJ3aGl0ZSI+VGVzdCBJbWFnZSAxPC90ZXh0Pgo8L3N2Zz4K"
          alt="Test Image 1"
          onclick="testStandalonePiP(this)"
          title="クリックでスタンドアロンPiP表示"
        />

        <img
          class="test-image"
          src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iZ3JhZGllbnQyIiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIxMDAlIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iIzc0YjlmZiIvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiMwMDc4ZmYiLz4KICAgIDwvbGluZWFyR3JhZGllbnQ+CiAgPC9kZWZzPgogIDxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjZ3JhZGllbnQyKSIvPgogIDxwb2x5Z29uIHBvaW50cz0iMTUwLDYwIDEyMCwxNDAgMTgwLDE0MCIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwwLjgpIi8+CiAgPHRleHQgeD0iMTUwIiB5PSIxMTAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzMzMyI+UGlQPC90ZXh0PgogIDx0ZXh0IHg9IjE1MCIgeT0iMzAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIyMCIgZmlsbD0id2hpdGUiPlRlc3QgSW1hZ2UgMjwvdGV4dD4KPC9zdmc+Cg=="
          alt="Test Image 2"
          onclick="testStandalonePiP(this)"
          title="クリックでスタンドアロンPiP表示"
        />
      </div>
    </div>

    <div class="test-container">
      <h2>🎮 コントロール</h2>
      <button class="button" onclick="testKeyboardShortcut()">
        🎹 Ctrl+Alt+S でスタンドアロンPiP起動
      </button>
      <button class="button" onclick="showInstructions()">
        📖 テスト手順を表示
      </button>
      <button class="button" onclick="checkSpacesSupport()">
        🖥️ Spaces対応チェック
      </button>
    </div>

    <div class="test-container">
      <h2>📊 ログ</h2>
      <div
        id="log"
        style="
          background: rgba(0, 0, 0, 0.3);
          padding: 10px;
          border-radius: 5px;
          font-family: monospace;
          height: 200px;
          overflow-y: auto;
        "
      >
        <div>✅ スタンドアロンPiPテストページが読み込まれました</div>
      </div>
    </div>

    <script>
      function log(message) {
        const logDiv = document.getElementById("log");
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement("div");
        logEntry.innerHTML = `[${timestamp}] ${message}`;
        logDiv.appendChild(logEntry);
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      function testStandalonePiP(imgElement) {
        log("🖼️ 画像クリック: " + imgElement.alt);

        // 画像データを取得
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        const img = new Image();

        img.onload = function () {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);

          // Base64データとして取得
          const imageData = canvas.toDataURL("image/png");
          log(
            "📤 画像データを準備しました: " + imageData.substring(0, 50) + "..."
          );

          // スタンドアロンPiPに送信（実際の実装では native bridge を使用）
          if (window.qt && window.qt.webChannelTransport) {
            log("🔗 Qt Web Channel経由でPiP起動を試行");
          } else {
            log(
              "⚠️ Qt Web Channelが見つかりません - キーボードショートカットをお試しください"
            );
          }
        };

        img.src = imgElement.src;
      }

      function testKeyboardShortcut() {
        log("⌨️ キーボードショートカット Ctrl+Alt+S を押してください");
        log(
          "💡 メインウィンドウでショートカットを押すとスタンドアロンPiPが起動します"
        );
      }

      function showInstructions() {
        log("📋 テスト手順:");
        log("1. Ctrl+Alt+S でスタンドアロンPiP起動");
        log("2. 画像をクリックしてPiP表示");
        log("3. Mission Control (F3) でSpace作成");
        log("4. Space間移動でPiP表示確認");
      }

      function checkSpacesSupport() {
        log("🖥️ macOS Spaces対応をチェック中...");
        log("✅ NSWindow Collection Behavior設定済み");
        log("✅ kCGFloatingWindowLevel設定済み");
        log("✅ CanJoinAllSpaces有効");
        log("💡 Mission Controlで複数Spaceを作成してテストしてください");
      }

      // ページ読み込み完了時の初期化
      document.addEventListener("DOMContentLoaded", function () {
        log("🚀 スタンドアロンPiPテストページ初期化完了");
        log("💡 Ctrl+Alt+SでスタンドアロンPiPを起動できます");
      });

      // キーボードイベントの監視
      document.addEventListener("keydown", function (event) {
        if (event.ctrlKey && event.altKey && event.key === "s") {
          log("🎹 スタンドアロンPiPショートカットが押されました");
          event.preventDefault();
        }
      });
    </script>
  </body>
</html>
