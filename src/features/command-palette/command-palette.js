/**
 * Command Palette Enhancement JavaScript
 * Handles command palette functionality and keyboard shortcuts
 */

class CommandPaletteHandler {
  constructor() {
    this.commands = [];
    this.isVisible = false;
    this.selectedIndex = 0;
    this.filteredCommands = [];
    this.init();
  }

  init() {
    this.setupKeyboardShortcuts();
    this.loadCommands();
    this.createPaletteElement();
    console.log("CommandPaletteHandler initialized");
  }

  setupKeyboardShortcuts() {
    // Ctrl+Shift+P „Åæ„Åü„ÅØ Cmd+Shift+P „Åß„Ç≥„Éû„É≥„Éâ„Éë„É¨„ÉÉ„ÉàË°®Á§∫
    document.addEventListener("keydown", (e) => {
      if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === "P") {
        e.preventDefault();
        this.toggle();
      }

      // ESC„Ç≠„Éº„ÅßÈñâ„Åò„Çã
      if (e.key === "Escape" && this.isVisible) {
        e.preventDefault();
        this.hide();
      }
    });
  }

  loadCommands() {
    this.commands = [
      {
        id: "reload",
        title: "„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø",
        description: "ÁèæÂú®„ÅÆ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Åæ„Åô",
        icon: "üîÑ",
        shortcut: "Ctrl+R",
        action: () => window.location.reload(),
      },
      {
        id: "back",
        title: "Ââç„ÅÆ„Éö„Éº„Ç∏„Å´Êàª„Çã",
        description: "„Éñ„É©„Ç¶„Ç∂„ÅÆÂ±•Ê≠¥„ÅßÂâç„ÅÆ„Éö„Éº„Ç∏„Å´Êàª„Çä„Åæ„Åô",
        icon: "‚Üê",
        shortcut: "Alt+‚Üê",
        action: () => history.back(),
      },
      {
        id: "forward",
        title: "Ê¨°„ÅÆ„Éö„Éº„Ç∏„Å´ÈÄ≤„ÇÄ",
        description: "„Éñ„É©„Ç¶„Ç∂„ÅÆÂ±•Ê≠¥„ÅßÊ¨°„ÅÆ„Éö„Éº„Ç∏„Å´ÈÄ≤„Åø„Åæ„Åô",
        icon: "‚Üí",
        shortcut: "Alt+‚Üí",
        action: () => history.forward(),
      },
      {
        id: "home",
        title: "„Éõ„Éº„É†„Éö„Éº„Ç∏„Å´ÁßªÂãï",
        description: "„Éõ„Éº„É†„Éö„Éº„Ç∏„Å´ÁßªÂãï„Åó„Åæ„Åô",
        icon: "üè†",
        shortcut: "Ctrl+H",
        action: () => this.goHome(),
      },
      {
        id: "bookmark",
        title: "„Éö„Éº„Ç∏„Çí„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ",
        description: "ÁèæÂú®„ÅÆ„Éö„Éº„Ç∏„Çí„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ„Å´ËøΩÂä†„Åó„Åæ„Åô",
        icon: "‚≠ê",
        shortcut: "Ctrl+D",
        action: () => this.addBookmark(),
      },
      {
        id: "fullscreen",
        title: "„Éï„É´„Çπ„ÇØ„É™„Éº„É≥Âàá„ÇäÊõø„Åà",
        description: "„Éï„É´„Çπ„ÇØ„É™„Éº„É≥„É¢„Éº„Éâ„ÅÆ„Ç™„É≥/„Ç™„Éï„ÇíÂàá„ÇäÊõø„Åà„Åæ„Åô",
        icon: "‚õ∂",
        shortcut: "F11",
        action: () => this.toggleFullscreen(),
      },
      {
        id: "devtools",
        title: "ÈñãÁô∫ËÄÖ„ÉÑ„Éº„É´„ÇíÈñã„Åè",
        description: "„Éñ„É©„Ç¶„Ç∂„ÅÆÈñãÁô∫ËÄÖ„ÉÑ„Éº„É´„ÇíÈñã„Åç„Åæ„Åô",
        icon: "üõ†",
        shortcut: "F12",
        action: () => this.openDevTools(),
      },
      {
        id: "search",
        title: "„Éö„Éº„Ç∏ÂÜÖÊ§úÁ¥¢",
        description: "„Éö„Éº„Ç∏ÂÜÖ„Åß„ÉÜ„Ç≠„Çπ„Éà„ÇíÊ§úÁ¥¢„Åó„Åæ„Åô",
        icon: "üîç",
        shortcut: "Ctrl+F",
        action: () => this.openSearch(),
      },
      {
        id: "print",
        title: "„Éö„Éº„Ç∏„ÇíÂç∞Âà∑",
        description: "ÁèæÂú®„ÅÆ„Éö„Éº„Ç∏„ÇíÂç∞Âà∑„Åó„Åæ„Åô",
        icon: "üñ®",
        shortcut: "Ctrl+P",
        action: () => window.print(),
      },
      {
        id: "zoom-in",
        title: "„Ç∫„Éº„É†„Ç§„É≥",
        description: "„Éö„Éº„Ç∏„ÇíÊã°Â§ß„Åó„Åæ„Åô",
        icon: "üîç+",
        shortcut: "Ctrl++",
        action: () => this.zoomIn(),
      },
      {
        id: "zoom-out",
        title: "„Ç∫„Éº„É†„Ç¢„Ç¶„Éà",
        description: "„Éö„Éº„Ç∏„ÇíÁ∏ÆÂ∞è„Åó„Åæ„Åô",
        icon: "üîç-",
        shortcut: "Ctrl+-",
        action: () => this.zoomOut(),
      },
      {
        id: "zoom-reset",
        title: "„Ç∫„Éº„É†„É™„Çª„ÉÉ„Éà",
        description: "„Ç∫„Éº„É†„É¨„Éô„É´„Çí100%„Å´Êàª„Åó„Åæ„Åô",
        icon: "üîç=",
        shortcut: "Ctrl+0",
        action: () => this.zoomReset(),
      },
    ];
  }

  createPaletteElement() {
    const overlay = document.createElement("div");
    overlay.className = "command-palette-overlay";
    overlay.style.display = "none";

    overlay.innerHTML = `
            <div class="command-palette">
                <div class="command-palette-header">
                    <input type="text" class="command-palette-input" placeholder="„Ç≥„Éû„É≥„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ...">
                </div>
                <div class="command-palette-list"></div>
                <div class="command-palette-footer">
                    <div class="command-palette-hint">
                        <span><span class="command-key">‚Üë‚Üì</span> ÈÅ∏Êäû</span>
                        <span><span class="command-key">Enter</span> ÂÆüË°å</span>
                        <span><span class="command-key">Esc</span> Èñâ„Åò„Çã</span>
                    </div>
                </div>
            </div>
        `;

    document.body.appendChild(overlay);
    this.paletteElement = overlay;
    this.inputElement = overlay.querySelector(".command-palette-input");
    this.listElement = overlay.querySelector(".command-palette-list");

    this.setupPaletteEvents();
  }

  setupPaletteEvents() {
    // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅÆ„Ç§„Éô„É≥„Éà
    this.inputElement.addEventListener("input", (e) => {
      this.filterCommands(e.target.value);
    });

    this.inputElement.addEventListener("keydown", (e) => {
      if (e.key === "ArrowDown") {
        e.preventDefault();
        this.selectNext();
      } else if (e.key === "ArrowUp") {
        e.preventDefault();
        this.selectPrevious();
      } else if (e.key === "Enter") {
        e.preventDefault();
        this.executeSelected();
      }
    });

    // „Ç™„Éº„Éê„Éº„É¨„Ç§„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
    this.paletteElement.addEventListener("click", (e) => {
      if (e.target === this.paletteElement) {
        this.hide();
      }
    });
  }

  toggle() {
    if (this.isVisible) {
      this.hide();
    } else {
      this.show();
    }
  }

  show() {
    this.isVisible = true;
    this.paletteElement.style.display = "flex";
    this.inputElement.value = "";
    this.inputElement.focus();
    this.filterCommands("");
    this.selectedIndex = 0;
    this.updateSelection();
  }

  hide() {
    this.isVisible = false;
    this.paletteElement.style.display = "none";
  }

  filterCommands(query) {
    const lowercaseQuery = query.toLowerCase();
    this.filteredCommands = this.commands.filter(
      (command) =>
        command.title.toLowerCase().includes(lowercaseQuery) ||
        command.description.toLowerCase().includes(lowercaseQuery)
    );

    this.selectedIndex = 0;
    this.renderCommands();
    this.updateSelection();
  }

  renderCommands() {
    if (this.filteredCommands.length === 0) {
      this.listElement.innerHTML = `
                <div class="command-no-results">
                    <span class="command-no-results-icon">üîç</span>
                    <div class="command-no-results-text">Ë©≤ÂΩì„Åô„Çã„Ç≥„Éû„É≥„Éâ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</div>
                </div>
            `;
      return;
    }

    this.listElement.innerHTML = this.filteredCommands
      .map(
        (command, index) => `
            <div class="command-item" data-index="${index}">
                <div class="command-icon">${command.icon}</div>
                <div class="command-content">
                    <div class="command-title">${command.title}</div>
                    <div class="command-description">${command.description}</div>
                </div>
                <div class="command-shortcut">${command.shortcut}</div>
            </div>
        `
      )
      .join("");

    // „Ç¢„Ç§„ÉÜ„É†„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
    this.listElement
      .querySelectorAll(".command-item")
      .forEach((item, index) => {
        item.addEventListener("click", () => {
          this.selectedIndex = index;
          this.executeSelected();
        });

        item.addEventListener("mouseenter", () => {
          this.selectedIndex = index;
          this.updateSelection();
        });
      });
  }

  updateSelection() {
    const items = this.listElement.querySelectorAll(".command-item");
    items.forEach((item, index) => {
      item.classList.toggle("selected", index === this.selectedIndex);
    });
  }

  selectNext() {
    if (this.filteredCommands.length > 0) {
      this.selectedIndex =
        (this.selectedIndex + 1) % this.filteredCommands.length;
      this.updateSelection();
    }
  }

  selectPrevious() {
    if (this.filteredCommands.length > 0) {
      this.selectedIndex =
        this.selectedIndex === 0
          ? this.filteredCommands.length - 1
          : this.selectedIndex - 1;
      this.updateSelection();
    }
  }

  executeSelected() {
    if (this.filteredCommands.length > 0 && this.selectedIndex >= 0) {
      const command = this.filteredCommands[this.selectedIndex];
      this.hide();
      command.action();
    }
  }

  // „Ç≥„Éû„É≥„Éâ„Ç¢„ÇØ„Ç∑„Éß„É≥
  goHome() {
    if (window.qt && window.qt.webChannelTransport) {
      window.qt.webChannelTransport.send({ type: "goHome" });
    }
  }

  addBookmark() {
    if (window.bookmarkHandler) {
      window.bookmarkHandler.showAddBookmarkDialog();
    }
  }

  toggleFullscreen() {
    if (window.qt && window.qt.webChannelTransport) {
      window.qt.webChannelTransport.send({ type: "toggleFullscreen" });
    }
  }

  openDevTools() {
    if (window.qt && window.qt.webChannelTransport) {
      window.qt.webChannelTransport.send({ type: "openDevTools" });
    }
  }

  openSearch() {
    if (window.qt && window.qt.webChannelTransport) {
      window.qt.webChannelTransport.send({ type: "openSearch" });
    }
  }

  zoomIn() {
    if (window.qt && window.qt.webChannelTransport) {
      window.qt.webChannelTransport.send({ type: "zoomIn" });
    }
  }

  zoomOut() {
    if (window.qt && window.qt.webChannelTransport.send) {
      window.qt.webChannelTransport.send({ type: "zoomOut" });
    }
  }

  zoomReset() {
    if (window.qt && window.qt.webChannelTransport) {
      window.qt.webChannelTransport.send({ type: "zoomReset" });
    }
  }
}

// „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´ÂàùÊúüÂåñ
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", () => {
    window.commandPaletteHandler = new CommandPaletteHandler();
  });
} else {
  window.commandPaletteHandler = new CommandPaletteHandler();
}
